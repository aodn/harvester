<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet author="talend" id="create_file_metadata_table-1">
      <sql>
	CREATE TABLE file_metadata
	(
	  file_id bigint NOT NULL,
	  deployment_number varchar(3) NOT NULL,
	  delivery_mode varchar(3) NOT NULL,
	  time_coverage_start timestamp with time zone,
	  time_coverage_end timestamp with time zone,
	  date_created  timestamp with time zone,
	  CONSTRAINT file_metadata_indexed_file_fk FOREIGN KEY (file_id)
	      REFERENCES indexed_file (id) MATCH SIMPLE
	      ON UPDATE CASCADE ON DELETE CASCADE,
	  CONSTRAINT file_metadata_file_id_uc UNIQUE (file_id)
	);
      </sql>
    </changeSet>
	  

    <changeSet author="talend" id="create_timeseries_table-1">
      <sql>
	CREATE TABLE timeseries
	(
	  deployment_number varchar(3) NOT NULL,
	  mean_latitude double precision,
	  mean_longitude double precision,
	  geom geometry(Geometry,4326),
	  time_deployment_start timestamp with time zone,
	  time_deployment_end timestamp with time zone,
	  CONSTRAINT timeseries_pk PRIMARY KEY (deployment_number),
	  CONSTRAINT timeseries_geom_check CHECK (st_isvalid(geom))
	);
      </sql>
    </changeSet>


    <changeSet author="talend" id="create_geometry_index-1">
      <sql>
	CREATE INDEX timeseries_gist_idx ON timeseries USING GIST (geom); 
      </sql>
    </changeSet>


    <changeSet author="talend" id="create_measurement_table-1">
      <sql>
	CREATE TABLE measurement
	(
	  deployment_number varchar(3) NOT NULL,
	  delivery_mode varchar(3) NOT NULL,
	  file_id bigint NOT NULL,
	  index bigint NOT NULL,
	  "TIME" timestamp with time zone NOT NULL,
	  "LATITUDE" real,
	  "LONGITUDE" real,
	  "PL_CMP" real,
	  "WDIR" real,
	  "WSPD" real,
	  "WIND_H" real,
	  "WIND_FLAG" integer,
	  "ATMP" real,
	  "ATMP_H" real,
	  "ATMP_FLAG" integer,
	  "AIRT" real,
	  "AIRT_H" real,
	  "AIRT_FLAG" integer,
	  "RELH" real,
	  "RELH_H" real,
	  "RELH_FLAG" integer,
	  "TEMP" real,
	  "TEMP_H" real,
	  "TEMP_FLAG" integer,
	  "RAIN_AMOUNT" real,
	  "RAIN_AMOUNT_H" real,
	  "RAIN_AMOUNT_FLAG" integer,
	  "SW" real,
	  "SW_H" real,
	  "SW_FLAG" integer,
	  "LW" real,
	  "LW_H" real,
	  "LW_FLAG" integer,
	  "HS" real,
	  "HL" real,
	  "H_RAIN" real,
	  "TAU" real,
	  "SST" real,
	  "HEAT_NET" real,
	  "MASS_NET" real,
	  "LW_NET" real,
	  "SW_NET" real,
	  "WSPD10M" real,
	  "AIRT1_5M" real,
	  "AIRT2_0M" real,
	  "RELH1_5M" real,
	  "RELH2_0M" real,
	  CONSTRAINT measurement_pk PRIMARY KEY (file_id , index ),
	  CONSTRAINT measurement_file_metadata_fk FOREIGN KEY (file_id)
	      REFERENCES file_metadata (file_id) MATCH SIMPLE
	      ON UPDATE CASCADE ON DELETE CASCADE
	);
	COMMENT ON COLUMN measurement.index IS 'index of measurement in netCDF file';
      </sql>
    </changeSet>


    <changeSet author="talend" id="create_rt_map_view-2">
      <sql>
	CREATE VIEW abos_sofs_surfaceflux_rt_map AS
	  SELECT DISTINCT timeseries.*
	  FROM timeseries JOIN file_metadata USING (deployment_number)
	  WHERE delivery_mode = 'RT';
      </sql>
    </changeSet>


    <changeSet author="talend" id="create_rt_data_view-2">
      <sql>
	CREATE VIEW abos_sofs_surfaceflux_rt_data AS
	  SELECT 
	    measurement.*,
	    timeseries.geom
	  FROM measurement JOIN timeseries USING (deployment_number)
	  WHERE delivery_mode = 'RT'
	  ORDER BY file_id, index;
      </sql>
    </changeSet>


    <changeSet author="talend" id="create_dm_map_view-2">
      <sql>
	CREATE VIEW abos_sofs_surfaceflux_dm_map AS
	  SELECT DISTINCT timeseries.*
	  FROM timeseries JOIN file_metadata USING (deployment_number)
	  WHERE delivery_mode = 'DM';
      </sql>
    </changeSet>


    <changeSet author="talend" id="create_dm_data_view-2">
      <sql>
	CREATE VIEW abos_sofs_surfaceflux_dm_data AS
	  SELECT 
	    measurement.*,
	    timeseries.geom
	  FROM measurement JOIN timeseries USING (deployment_number)
	  WHERE delivery_mode = 'DM'
	  ORDER BY file_id, index;
      </sql>
    </changeSet>


</databaseChangeLog>
